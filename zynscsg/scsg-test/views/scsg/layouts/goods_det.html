<script type="text/javascript">

/**
 * 获取评论数据
 * @page 分页数
 */
function comment_ajax(page, type)
{
    if(!page && $.trim($('#commentBox').text()))
    {
        return;
    }
    page = page ? page : 1;
    type = type ? type : 'all';
    var url = '{url:/site/cir_comment_ajax/page/@page@/type/@type@/goods_id/$id}';
    url = url.replace("@page@",page);
    url = url.replace("@type@",type);
    $.getJSON(url,function(json)
    {
        //清空评论数据
        $('#commentBox').empty();

        for(var item in json.data)
        {
            var commentHtml = template.render('commentRowTemplate',json.data[item]);
            $('#commentBox').append(commentHtml);
        }
        $('#commentBox').append(json.pageHtml);
        /*点击回复出现弹框*/
        $(document).on('click', '.js_replay_comment',function(){
            var _this = $(this),
                _id = _this.attr('js_data'),
                _name = _this.attr('js_name'),
                _url = '{url:/site/cir_comment_ajax/page/1/pid/@pid@/goods_id/$id}';
            _url = _url.replace("@pid@",_id);
            _this.attr('class', 'js_hide_reply_comment');
            $.getJSON(_url,function(json){
                var html = "<div class='bg-hf'>";
                    html += "<div class='reply-textarea J-reply-con' style='margin-bottom: 10px;display:block;'>";
                    html += '<div class="reply-arrow">';
                    html += '<b class="layer1"></b>';
                    html += '<b class="layer2"></b>';
                    html += '</div>';   
                    html += '<div class="inner js_inner">';   
                    html += '<textarea class="reply-input" name="content" placeholder="回复 '+_name+'："></textarea>';   
                    html += '<div class="btnbox">';   
                    html += '<button type="button" data-nick="'+_name+'" data-guid="033e3bec-d2aa-42d1-9168-095d92f6793f" data-replyid="1198778752" class="reply-submit J-submit-reply J-submit-reply-lz js_reply_submit" js_data='+_id+'>提交回复</button>';
                    html += '</div></div><hr/></div>';
                    
                    for(var i = 0; i < json.data.length; i ++){
                        if(json.data[i]['user_id'] == -1)
                        {
                            html += '<p><span class="colors">'+json.data[i]['username']+'：</span><span class="red">'+json.data[i]['contents']+'</span><span class="times">'+json.data[i]['comment_time']+'</span></p>'
                        }
                        else
                        {
                           html += '<p><span class="replys J-reply-trigger">'+json.data[i]['username']+':</span><span class="gray">'+json.data[i]['contents']+'</span><span class="times">'+json.data[i]['comment_time']+'</span></p>'; 
                        }
                        html += '<p class="js_replay_comment" js_data="'+json.data[i]['id']+'" js_name="'+json.data[i]['username']+'"><span class="replys J-reply-trigger" id="hf_'+json.data[i]['id']+'">回复（'+json.data[i]['reply']+'）</span></p><div class="js_comment_list_'+json.data[i]['id']+'"></div>';
                    }
                    html += '</div>';
                _this.siblings('.js_comment_list_'+_id).html(html);
            })
        })
    });
}

$(document).on('click', '.js_hide_reply_comment',function(){
    $(this).attr('class', 'js_replay_comment').next('div').html('');
})

//回复评论
$(document).on('click', '.js_reply_submit', function(){
    var _this = $(this)
        ,_pid = _this.attr('js_data')
        ,_c = _this.parents('.js_inner').find('textarea').val();
        if(_c.length == 0){
            alert('请输入评论内容');return;
        }
        $.ajax({
            type: "POST",
            url: "{url:site/comment_reply}",
            data: {pid: _pid, content: _c},
            dataType: "json",
            success: function(data){
                if(!data.status)
                {
                    alert(data.msg);
                }
                else
                {
                    comment_ajax(1, 'all');
                }
            }
        })
})

/**
 * 获取咨询数据
 * @page 分页数
 */
function refer_ajax(page, type)
{
    if(!page && $.trim($('#referBox').text()))
    {
        return;
    }
    page = page ? page : 1;
    var url = '{url:/site/cir_refer_ajax/page/@page@/type/@type@/goods_id/$id}';
    url = url.replace("@page@",page);
    url = url.replace("@type@",type);
    $.getJSON(url,function(json)
    {
        $('#referBox').empty();

        for(var item in json.data)
        {
            var commentHtml = template.render('referRowTemplate',json.data[item]);
            $('#referBox').append(commentHtml);
        }
        $('#referBox').append(json.pageHtml);
        
        /*点击回复出现弹框*/
        $(document).on('click', '.js_replay_question',function(){
            var _this = $(this),
                _id = _this.attr('js_data'),
                _name = _this.attr('js_name'),
                _url = '{url:/site/cir_refer_ajax/page/1/pid/@pid@/goods_id/$id/type/@type@}';
            _url = _url.replace("@pid@",_id);
            _url = _url.replace("@type@",type);
            _this.attr('class', 'js_hide_reply_question');
            $.getJSON(_url,function(json){
                var html = "<div class='bg-hf'>";
                    html += "<div class='reply-textarea J-reply-con' style='margin-bottom: 10px;display:block;'>";
                    html += '<div class="reply-arrow">';
                    html += '<b class="layer1"></b>';
                    html += '<b class="layer2"></b>';
                    html += '</div>';   
                    html += '<div class="inner js_inner">';   
                    html += '<textarea class="reply-input" name="question" placeholder="回复 '+_name+'："></textarea>';   
                    html += '<div class="btnbox">';   
                    html += '<button type="button" data-nick="'+_name+'" data-guid="033e3bec-d2aa-42d1-9168-095d92f6793f" data-replyid="1198778752" class="reply-submit J-submit-reply J-submit-reply-lz js_reply_question_submit" js_data='+_id+' js_type='+type+'>提交回复</button>';
                    html += '</div></div><hr/></div>';
                    for(var i = 0; i < json.data.length; i ++){
                        html += '<p><span class="replys J-reply-trigger">'+json.data[i]['username']+':</span><span class="gray">'+json.data[i]['question']+'</span><span class="times">'+json.data[i]['time']+'</span></p>';
                        html += '<p class="js_replay_question" js_data="'+json.data[i]['id']+'" js_name="'+json.data[i]['username']+'"><span class="replys J-reply-trigger" id="hf_'+json.data[i]['id']+'">回复（'+json.data[i]['reply']+'）</span></p><div class="js_question_list_'+json.data[i]['id']+'"></div>';
                    }
                    html += '</div>';
                _this.siblings('.js_question_list_'+_id).html(html);
            })
        })     
        
    });
}
$(document).on('click', '.js_hide_reply_question',function(){
    $(this).attr('class', 'js_replay_question').next('div').html('');
})
$(document).on('click', '.js_reply_question_submit', function(){
    var _this = $(this)
        ,_pid = _this.attr('js_data')
        ,_type = _this.attr('js_type')
        ,_c = _this.parents('.js_inner').find('textarea').val();
        if(_c.length == 0){
            alert('请输入回复内容');return;
        }
        $.ajax({
            type: "POST",
            url: "{url:site/question_reply}",
            data: {pid: _pid, question: _c},
            dataType: "json",
            success: function(data){
                if(!data.status)
                {
                    alert(data.msg);
                    return;
                }
                else
                {
                    refer_ajax(1, _type);
                }
            }
        })
})
$(document).on('click', '.js_show_big_photo', function(){
    var _u = new Image();
    _u.src = $(this).attr('src')
    var _w = _u.width > 500 ? 500 : _u.width
        ,html = '<p class="js_hide_big_photo" style="margin-top:10px;width:26px; height:20px; border:1px solid gray;cursor:pointer;">关闭</p><br/><img src='+_u.src+' width='+_w+'/>';
    $(this).parents('.js_photo').next('p').html(html);
})
$(document).on('click', '.js_hide_big_photo', function(){
    $(this).parents('p').html('');
})
</script>
<style type="text/css">
    .js_show_big_photo{
        width: 50px; height: 50px; border: 2px solid #F0F0F0;
    }
    .js_show_big_photo:hover{
         border: 2px solid #FF6600;
    }
</style>
<!--滑动面tab标签-->
	<div class="main f_r" style="overflow:hidden; width:950px;">

		<div class="uc_title" name="showButton">
			<label class="current"><span>商品详情</span></label>
			{if:($attribute)}
			<label class="spec"><span>规格参数</span></label>
			{/if}
			<label id='point'><span>顾客评价({$comment_num})</span></label>
			<label id='buyHistory'><span>购买记录({$buy_num})</span></label>
			<label><span>咨询({$refer_num})</span></label>
		</div>

		<div name="showBox">
			<!-- 商品详情 start -->
			<div>
				<ul class="saleinfos m_10 clearfix">
					<li>商品名称：{$name}</li>

					{if:isset($brand) && $brand}
					<li>品牌：{$brand}</li>
					{/if}
					
					{if:isset($weight) && $weight}
					<li>商品毛重：<label id="data_weight">{$weight}</label></li>
					{/if}
					
					{if:isset($unit) && $unit}
					<li>单位：{$unit}</li>
					{/if}

					{if:isset($up_time) && $up_time}
					<li>上架时间：{$up_time}</li>
					{/if}
					
					
				</ul>
				{if:isset($content) && $content}
				<div class="salebox">
					<strong class="saletitle block">产品描述：</strong>
					<p class="saledesc">{$content}</p>
				</div>
				{/if}
			</div>
			<!-- 商品详情 end -->
			{if:($attribute)}
			<div id='spec_box' class='hidden'>
				<div>
				<ul class="saleinfos m_10 clearfix">
				
					{foreach:items=$attribute}
					<li>{$item['name']}：{$item['attribute_value']}</li>
					{/foreach}
					
				</ul>
				</div>
			</div>
			{/if}
			<!-- 顾客评论 start -->
			<div class="hidden comment_list box">
				<!-- <div class="title3">
					<span class="f_r f12 light_gray normal">
						只有购买过该商品的用户才能进行评价
						{if:isset($this->user['user_id']) && $user_id = $this->user['user_id']}
						{foreach:items=Api::run('getCommentByGoodsid',array('#id#',$id),array('#user_id#',$user_id),1) }
						<a class="comm_btn" href="{url:/site/comments/id/$item[id]}"  target="_blank">我要评论</a>
						{/foreach}
						{/if}
					</span>
					<img src="{skin:images/front/comm.gif}" width="16px" height="16px" />商品评论<span class="f12 normal">（已有<b class="red2">{$comments}</b>条）</span>
				</div> -->
			
				<script type="text/javascript">
					$(document).ready(function(){
						/*选择评价*/
						$(".m-tab-trigger .trig-item").click(function(){
							$(".m-tab-trigger .trig-item").removeClass("curr");
							$(this).addClass("curr");
                            var _type = $(this).attr('js_data');
                            comment_ajax(1, _type);
						});

					});
				</script>
				<div class="mt-inner m-tab-trigger-wrap clearfix">
       				<ul class="m-tab-trigger">
           			 	<li class="ui-switchable-item trig-item curr" js_data="all" clstag="shangpin|keycount|product|allpingjia_2"><a href="javascript:;">全部评价<em>({$comment_num})</em></a></li>
            		 	<li class="ui-switchable-item trig-item" js_data="good" clstag="shangpin|keycount|product|haoping_2"><a href="javascript:;">好评<em>({$good_comment})</em></a></li>
             			<li class="ui-switchable-item trig-item" js_data="middle" clstag="shangpin|keycount|product|zhongping_2"><a href="javascript:;">中评<em>({$middle_comment})</em></a></li>
             			<li class="ui-switchable-item trig-item" js_data="bad" clstag="shangpin|keycount|product|chaping_2"><a href="javascript:;">差评<em>({$bad_comment})</em></a></li>
        			</ul>
    			</div>

				<div id='commentBox'></div>

				<!--评论JS模板-->
				<script type='text/html' id='commentRowTemplate'>

				<div class="item">
					<div class="user">
						<div class="ico">
							<a href="javascript:void(0)">
								<img src="{webroot:<%=head_ico%>}" width="70px" height="70px" onerror="this.src='{skin:images/front/user_ico.gif}'" />
							</a>
						</div>
						<span class="blue"><%=username%></span>
					</div>
					<dl class="desc">
						<% var widthPoint = 14 * point;%>
						<p class="clearfix">
							<b>评分：</b>
							<span class="grade"><i style="width:<%=widthPoint%>px"></i></span>
							<span class="light_gray"><%=comment_time%></span><label></label>
						</p>
						<hr />
						<p><b>评价：</b><span class="gray"><%=contents%></span></p>
                        <%if(photo){%>
                        <p class="js_photo">
                        <%for(i = 0; i < photo.length; i ++) {%>
                            <img src="{webroot:<%=photo[i]['img']%>}" class="js_show_big_photo"/>
                        <%}%>
                        </p>
                        <p></p>
                        <%}%>
                        <%if(replySelf){%>
                        <p><b>追加评价：</b><span class="gray"><%=replySelf['contents']%></span></p>
                        <%if(replySelfPhoto){%>
                        <p class="js_photo">
                        <%for(i = 0; i < replySelfPhoto.length; i ++) {%>
                            <img src="{webroot:<%=replySelfPhoto[i]['img']%>}" class="js_show_big_photo"/>
                        <%}%>
                        </p>
                        <%}%>
                        <p></p>
                        <%}%>
						<!--修改评价-->
						<div class="huifu">
						<p class="js_replay_comment" js_data="<%=id%>" js_name="<%=username%>"><span class="replys J-reply-trigger" id="hf_<%=id%>">回复（<%=reply%>）</span></p>
                        <div class="js_comment_list_<%=id%>"></div>
				    </div>
				    <hr/>
					<!--修改评价-->
					<%if(replyData){%>
                        <%for(i = 0; i < replyData.length; i ++) {%>
                        <p class="bg_gray"><img src="{skin:images/front/answer.gif}" width="16px" height="17px" />
                        <b class="orange"><%=replyData[i]['seller_name']%>回复：</b><span class="f_r"><%=comment_time%></span></p>
                        <p class="indent bg_gray"><%=replyData[i]['contents']%></p>
                        <div class="ts">
                            <p class="js_replay_comment" js_data="<%=replyData[i]['id']%>" js_name="<%=replyData[i]['seller_name']%>"><span class="replys J-reply-trigger re-hf" id="hf_<%=replyData[i]['id']%>" >回复（<%=replyData[i]['reply']%>）</span></p>
                            <div class="js_comment_list_<%=replyData[i]['id']%>"></div>
                        </div>
                        <%}%>
                        <%}%>	
					</dl>
					<div class="corner b"></div>

				</div>
				<hr />
				</script>
			</div>
			<!-- 顾客评论 end -->

			<!-- 购买记录 start -->
			<div class="hidden box" >
				<div class="title3" >
					<img src="{skin:images/front/cart.gif}" width="16" height="16" alt="" />
					购买记录<span class="f12 normal">（已有<b class="red2">{$buy_num}</b>购买）</span>
				</div>

				<table width="100%" class="list_table m_10 mt_10">
					<col width="150" />
					<col width="120" />
					<col width="120" />
					<col width="150" />
					<col />
					<thead class="thead">
						<tr>
							<th>购买人</th>
							<th>出价</th>
							<th>数量</th>
							<th>购买时间</th>
							<th>状态</th>
						</tr>
					</thead>
				</table>

				<table width="100%" class="list_table m_10">
					<col width="150" />
					<col width="120" />
					<col width="120" />
					<col width="150" />
					<col />
					<tbody class="dashed" id="historyBox"></tbody>

					<!--购买历史js模板-->
					<script type='text/html' id='historyRowTemplate'>
					<tr>
						<td><%=show%></td>
						<td><%=goods_price%></td>
						<td class="bold orange"><%=goods_nums%></td>
						<td class="light_gray"><%=completion_time%></td>
						<td class="bold blue">成交</td>
					</tr>
					</script>
				</table>
			</div>
			<!-- 购买记录 end -->

			<!-- 购买前咨询 start -->
			<div class="hidden comment_list box">
                <script type="text/javascript">
                    $(function(){
                        /*选择咨询*/
                        $(".m-tab-trigger .trig-item-refer").click(function(){
                            $(".m-tab-trigger .trig-item-refer").removeClass("curr");
                            $(this).addClass("curr");
                            var _type = $(this).attr('js_data');
                            refer_ajax(1, _type);
                        });

                    });
                </script>
				<div class="mt-inner m-tab-trigger-wrap clearfix">
                    <span class="f_r normal"><a class="comm_btn" style="margin: 3px 5px;" href="{url:/site/consult/id/$id}" target="_blank">我要咨询</a></span>
                    {if:$refer}
                    <ul class="m-tab-trigger">
                    {foreach: items=$refer}
                    {if:$item['id']==$this->type}
                        <li class="ui-switchable-item trig-item trig-item-refer curr" js_data="{$item['id']}"><a href="javascript:;">{$item['name']}<em>({$item['num']})</em></a></li>
                    {else:}
                        <li class="ui-switchable-item trig-item trig-item-refer" js_data="{$item['id']}"><a href="javascript:;">{$item['name']}<em>({$item['num']})</em></a></li>
                    {/if}
                    {/foreach}
                    </ul>
                    {/if}
				</div>

				<div id='referBox'></div>

				<!--购买咨询JS模板-->
				<script type='text/html' id='referRowTemplate'>
				<div class="item">
					<div class="user">
						<div class="ico"><img src="{webroot:<%=head_ico%>}" width="70px" height="70px" onerror="this.src='{skin:images/front/user_ico.gif}'" /></div>
						<span class="blue"><%=username%></span>
						<p class="gray"><%=rtime%></p>
					</div>
					<dl class="desc gray">
						<p>
							<img src="{skin:images/front/ask.gif}" width="16px" height="17px" />
							<b>咨询内容：</b><span class="f_r"><%=time%></span>
						</p>

						<p class="indent"><%=question%></p>
						<!--增加咨询回复-->
						<div class="huifu">
							<p class="js_replay_question" js_data="<%=id%>" js_name="<%=username%>"><span class="replys J-reply-trigger" id="hf_<%=id%>">回复（<%=reply%>）</span></p>
                            <div class="js_question_list_<%=id%>"></div>
				    </div>
				   <!--增加咨询回复-->
						<hr />
						<%if(replyData){%>
                        <%for(i = 0; i < replyData.length; i ++) {%>
                        <p class="bg_gray"><img src="{skin:images/front/answer.gif}" width="16px" height="17px" />
                        <b class="orange"><%=replyData[i]['seller_name']%>回复：</b><span class="f_r"><%=replyData[i]['time']%></span></p>
                        <p class="indent bg_gray"><%=replyData[i]['question']%></p>
                        <div class="ts">
                            <p class="js_replay_question" js_data="<%=replyData[i]['id']%>" js_name="<%=replyData[i]['seller_name']%>"><span class="replys J-reply-trigger re-hf" id="hf_<%=replyData[i]['id']%>" >回复（<%=replyData[i]['reply']%>）</span></p>
                            <div class="js_question_list_<%=replyData[i]['id']%>"></div>
                        </div>
                        <%}%>
                        <%}%>
					</dl>
					<div class="corner b"></div>
					<div class="corner tl"></div>
				</div>
				<hr />
				</script>
			</div>
			<!-- 购买前咨询 end -->

			
		</div>
	</div>